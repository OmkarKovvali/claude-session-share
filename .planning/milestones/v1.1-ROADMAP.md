# Milestone v1.1: Session Format Compatibility

**Status:** âœ… SHIPPED 2026-01-14
**Phases:** 8
**Total Plans:** 1

## Overview

Support both old (v1.x) and new (v2.0.76+) Claude Code session formats with automatic detection and full backward compatibility. This milestone was created in response to a breaking change in Claude Code v2.0.76 that changed the session format from `snapshot.messages` array to `message.content` API response object.

## Phases

### Phase 8: Session Format Compatibility

**Goal**: Detect and handle both old and new Claude Code session formats seamlessly
**Depends on**: v1.0 complete
**Plans**: 1 plan

Plans:

- [x] 08-01: Session format compatibility implementation

**Details:**

This phase adds dual-format support to the existing codebase:
- Session format version detection (old `snapshot.messages` vs new `message.content`)
- Updated TypeScript types supporting both formats with optional fields
- Modified sanitization logic handling both formats with format-specific processing
- Comprehensive tests for format detection and conversion (24 new tests)
- All 388 existing tests continue passing (backward compatibility verified)

**Key Implementation Decisions:**

1. **Format Detection Approach**: Uses presence check (`if msg.snapshot` / `if msg.message`) rather than discriminated union with formatVersion field - simpler and self-identifying
2. **Thinking Block Handling**: Old format sets thinking field to null, new format filters thinking blocks entirely from content array
3. **Tool Block Preservation**: All non-thinking content blocks preserved as-is in new format for session replay

**Test Results:**
- All 388 existing tests pass without modification
- 24 new tests added for v2.0.76+ format
- Format detection working correctly
- Mixed sessions (old + new format messages) handled seamlessly

---

## Milestone Summary

**Decimal Phases:**
None (single-phase milestone)

**Key Decisions:**

- Format detection via presence check rather than version field - Simpler implementation, formats self-identify by structure
- Optional fields (snapshot?, message?) instead of discriminated union - Avoids version number maintenance
- Filter thinking blocks in new format, nullify in old format - Format-appropriate handling

**Issues Resolved:**

- Tool breakage with Claude Code v2.0.76+ sessions (caused by format change)
- TypeScript type errors with optional snapshot field in existing tests
- Test fixture secret pattern mismatch (updated to match existing redactor patterns)

**Issues Deferred:**
None

**Technical Debt Incurred:**
None - clean implementation following existing patterns

---

_For current project status, see .planning/ROADMAP.md_

---
phase: 08-session-format-compatibility
plan: 01
type: execute
---

<objective>
Support both old (v1.x) and new (v2.0.76+) Claude Code session formats with backward compatibility.

Purpose: Claude Code v2.0.76 changed the assistant message format from `snapshot.messages` array to `message.content` API response object. This plan adds format detection and dual-format support without breaking existing functionality.

Output: Type system and sanitization logic that seamlessly handles both old and new formats, with all 388 existing tests passing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/session/types.ts
@src/sanitization/sanitizer.ts
@src/__tests__/sanitizer.test.ts

**Tech stack available:** TypeScript, Vitest, Node.js built-ins
**Established patterns:** Discriminated unions for message types, immutable sanitization, service layer pattern
**Constraining decisions:**
- Phase 2: Session format uses JSONL with discriminated union types (type field)
- Phase 3: Sanitization is immutable (returns new objects, never mutates)
- All phases: No external dependencies for core functionality (Node.js built-ins only)

**Format change details:**
- Old format (v1.x): `AssistantMessage` has `snapshot: { thinking: string | null, messages: Array<{role, content}> }`
- New format (v2.0.76+): `AssistantMessage` has `message: { model, id, type, role, content: Array<ContentBlock>, stop_reason, usage }`
- Old format example: `snapshot.messages[0].content` is a string
- New format example: `message.content[0].text` is a string (content is array of blocks)
- Both formats still have `type: 'assistant'` for discriminated union

**Critical constraint:** All 388 existing tests must continue passing (backward compatibility is non-negotiable).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TypeScript types to support dual formats</name>
  <files>src/session/types.ts</files>
  <action>
Update the AssistantMessage type to support both formats using discriminated union or optional fields:

1. **Keep existing snapshot format (old v1.x):**
   - `snapshot?: { thinking: string | null, messages: Array<{role: string, content: string}> }`

2. **Add new message format (v2.0.76+):**
   - `message?: { model: string, id: string, type: string, role: string, content: Array<{type: string, text: string}>, stop_reason: string | null, usage: object }`

3. **Ensure at least one is present:** Add type guard or use discriminated union with a `formatVersion` field if needed.

4. **Don't break existing code:** The `snapshot` field must remain compatible with all existing test fixtures and sanitization code.

5. **Document the change:** Add JSDoc comments explaining the two formats and when each is used.

AVOID adding complex validation logic - keep type system simple and let TypeScript enforce structure. AVOID breaking changes to existing code that accesses `snapshot.messages`.
  </action>
  <verify>TypeScript build succeeds with `npm run build`, no type errors in sanitizer.ts or tests</verify>
  <done>AssistantMessage type supports both `snapshot` (old) and `message` (new) formats, TypeScript compilation succeeds</done>
</task>

<task type="auto">
  <name>Task 2: Update sanitization logic for dual format support</name>
  <files>src/sanitization/sanitizer.ts</files>
  <action>
Modify sanitizeAssistantMessage() to detect and handle both formats:

1. **Add format detection:** Check if `msg.snapshot` exists (old format) or `msg.message` exists (new format)

2. **Old format path (snapshot.messages):**
   - Keep existing logic: `snapshot.messages.map(m => ({ ...m, content: redactSecrets(sanitizePathsInContent(m.content, basePath)) }))`
   - Set `thinking: null` as before

3. **New format path (message.content):**
   - Extract text from content blocks: `message.content.map(block => block.type === 'text' ? { ...block, text: redactSecrets(sanitizePathsInContent(block.text, basePath)) } : block)`
   - Thinking blocks in new format are separate content blocks with `type: 'thinking'` - filter these out entirely
   - Preserve all other fields (model, id, stop_reason, usage, etc.)

4. **Return appropriate format:** If input was old format, return old format. If new, return new.

5. **Error handling:** If neither `snapshot` nor `message` exists, throw descriptive error.

AVOID mutating input objects. AVOID stripping non-text content blocks (preserve tool_use, tool_result blocks). WHY: New format uses content blocks for tool calls, stripping them breaks the session.
  </action>
  <verify>npm run build succeeds, manual smoke test with both format fixtures shows proper sanitization</verify>
  <done>sanitizeAssistantMessage() correctly sanitizes both old and new formats without mutation, thinking removed, paths sanitized, secrets redacted</done>
</task>

<task type="auto">
  <name>Task 3: Add comprehensive tests for new format</name>
  <files>src/__tests__/sanitizer.test.ts</files>
  <action>
Add test cases for new format while keeping all existing tests:

1. **New format test fixtures:** Create AssistantMessage objects with `message.content` structure (model v2.0.76+ format)

2. **Test coverage for new format:**
   - Thinking block removal (filter out `{type: 'thinking'}` content blocks)
   - Path sanitization in text blocks (`{type: 'text', text: '...'}`)
   - Secret redaction in text blocks
   - Preservation of tool_use and tool_result blocks
   - Multiple content blocks in single message

3. **Backward compatibility tests:** Ensure existing old format tests still pass (don't modify them)

4. **Format detection test:** Create test with old format, verify old-format output. Create test with new format, verify new-format output.

5. **Edge cases:**
   - Message with only thinking blocks (should result in empty content array)
   - Message with mixed text and tool blocks
   - Message with no thinking blocks (common case)

AVOID changing existing test fixtures (keep old format intact). WHY: Proves backward compatibility - if old tests still pass, old format still works.
  </action>
  <verify>npm test passes all tests (388+ tests with new additions), both old and new format tests passing</verify>
  <done>New format tests added covering all sanitization scenarios, all existing tests still passing, total test count increased</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] `npm test` passes all tests (388+ tests)
- [ ] Both old format (snapshot.messages) and new format (message.content) messages can be sanitized
- [ ] No existing tests were modified or removed (backward compatibility proof)
- [ ] Thinking blocks removed in both formats
- [ ] Paths sanitized in both formats
- [ ] Secrets redacted in both formats
</verification>

<success_criteria>

- All tasks completed
- TypeScript types support both formats
- Sanitization logic handles both formats correctly
- All verification checks pass
- No existing functionality broken
- Test suite expanded to cover new format
  </success_criteria>

<output>
After completion, create `.planning/phases/08-session-format-compatibility/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Session Format Compatibility Summary

**[One-liner describing what shipped - e.g., "Dual-format support for v1.x and v2.0.76+ session formats with full backward compatibility"]**

## Accomplishments

- [Key outcome 1 - e.g., "Type system updated to support both snapshot.messages and message.content formats"]
- [Key outcome 2 - e.g., "Sanitization logic detects and handles both formats transparently"]
- [Key outcome 3 - e.g., "Comprehensive test coverage for new format added while preserving all existing tests"]

## Files Created/Modified

- `src/session/types.ts` - Added dual-format support to AssistantMessage type
- `src/sanitization/sanitizer.ts` - Format detection and dual-path sanitization
- `src/__tests__/sanitizer.test.ts` - New format test coverage

## Decisions Made

[Document key decisions made during implementation, such as:]
- How format detection works (presence check vs version field)
- How thinking blocks are handled in new format (filter vs null field)
- Whether to preserve all content block types or filter some out

## Issues Encountered

[Problems and resolutions during implementation, or "None"]

## Next Phase Readiness

Phase 8 complete. All milestone v1.1 work finished. Ready for release.
</output>

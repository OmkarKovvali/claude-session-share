---
phase: 06-end-to-end-verification
type: execute
---

<objective>
Verify the complete session sharing workflow works end-to-end: sessions can be shared, imported, and resumed exactly like native Claude Code sessions.

Purpose: Validate that imported sessions are indistinguishable from native sessions - appearing in `claude --resume` and preserving full conversation context. This is the core value proposition of the project.
Output: Integration tests proving round-trip functionality, manual verification of Claude CLI integration, and confirmation that privacy sanitization is bulletproof.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant prior phase summaries
@.planning/phases/04-gist-storage/04-02-SUMMARY.md
@.planning/phases/05-session-import/05-02-SUMMARY.md

# Key source files
@src/index.ts
@src/services/session-uploader.ts
@src/services/session-importer.ts
@src/sanitization/sanitizer.ts

**Tech stack available:** TypeScript, Vitest, MCP SDK, Octokit
**Established patterns:** Service orchestration, async generators for streaming, per-line error recovery, module-level vi.mock for testing

**Constraining decisions:**
- Phase 04-02: Service layer pattern separates orchestration from MCP handlers
- Phase 05-02: Per-line error recovery for JSONL parsing maximizes data recovery
- Phase 03-01: False positive over false negative for secret redaction

**Issues being addressed:** None (validation phase)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create end-to-end integration test</name>
  <files>src/__tests__/e2e.test.ts</files>
  <action>
    Create comprehensive integration test verifying the full round-trip workflow:

    1. Create a minimal test session with multiple message types (user, assistant, tool_result)
    2. Include thinking blocks, file paths, and mock secrets to test sanitization
    3. Write test session to temporary location
    4. Use uploadSession() to share (mock GistClient to avoid real API calls)
    5. Use importSession() to import from mocked gist response
    6. Verify imported session has:
       - All messages preserved (count matches)
       - UUIDs remapped (different from original but valid chain structure)
       - Thinking blocks stripped (none in imported session)
       - File paths sanitized (no absolute paths)
       - Secrets redacted (API keys, tokens replaced with [REDACTED])
       - Session is valid JSONL (each line parseable)

    Mock GistClient with vi.mock to avoid external API dependency. Use real uploadSession/importSession services to test actual orchestration logic.

    Test should verify that the round-trip preserves conversation utility while removing privacy-sensitive data.
  </action>
  <verify>npm test -- e2e.test.ts passes, all assertions green</verify>
  <done>Integration test proves share → import workflow preserves messages, strips thinking, sanitizes paths, redacts secrets, and maintains valid JSONL structure</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>End-to-end integration test proving share → import workflow</what-built>
  <how-to-verify>
    Now we need to verify that imported sessions actually appear in Claude Code's `claude --resume` picker:

    1. Ensure you have a real GitHub token in environment: `export GITHUB_TOKEN=your_token`
    2. Create a test session by running a simple Claude Code conversation (or use an existing one)
    3. Run the MCP server: `npm run build && node dist/index.js` (it will stay running)
    4. In another terminal, use Claude Code with MCP configured to test:
       - Share a session: Should return a real GitHub Gist URL
       - Import that same session to a test project directory
       - Run `claude --resume` and verify the imported session appears in the list
       - Resume the imported session and verify conversation history is intact

    Expected behavior:
    - Imported session appears in picker with correct title/timestamp
    - Resuming shows full conversation history
    - No thinking blocks visible in resumed session
    - Paths are sanitized (no absolute file paths)
    - Session works exactly like a native Claude Code session

    Note: If you don't want to test with real GitHub, you can skip this and mark as "approved" - the integration test covers the core logic. This checkpoint is for validating the actual Claude CLI integration.
  </how-to-verify>
  <resume-signal>Type "approved" if the imported session appears correctly in `claude --resume`, or describe any issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Add privacy sanitization verification tests</name>
  <files>src/__tests__/e2e.test.ts</files>
  <action>
    Add dedicated test cases within the e2e test suite specifically for privacy verification:

    1. **Thinking block removal test:**
       - Create session with &lt;antml:thinking&gt; blocks in assistant messages
       - Verify imported session has zero thinking blocks (grep for 'antml:thinking' returns empty)

    2. **Path sanitization test:**
       - Create session with absolute paths in tool results (/Users/name/project/file.ts)
       - Verify imported session has relative paths only (project/file.ts)
       - Test multiple path formats (Windows, macOS, Linux)

    3. **Secret redaction test:**
       - Create session with API keys, tokens, passwords in tool results
       - Test patterns: sk_test_*, ghp_*, Bearer tokens, AWS keys, database URLs with passwords
       - Verify imported session has all secrets replaced with [REDACTED]
       - Verify legitimate content NOT redacted (e.g., regular UUIDs, hex values)

    These tests should use the existing sanitizer infrastructure but verify it works correctly in the full round-trip context.

    Use descriptive test names like "should strip all thinking blocks from shared sessions" for clarity.
  </action>
  <verify>npm test -- e2e.test.ts passes with privacy verification tests green, coverage shows all sanitization branches tested</verify>
  <done>Privacy tests confirm thinking blocks stripped, paths sanitized, and secrets redacted in round-trip workflow without false positives</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm test passes all tests including new e2e suite
- [ ] npm run build succeeds without errors
- [ ] Integration test proves share → import preserves messages and conversation structure
- [ ] Privacy tests confirm thinking blocks removed, paths sanitized, secrets redacted
- [ ] Manual verification confirms imported sessions appear in `claude --resume` (or documented as skipped)
</verification>

<success_criteria>

- All tasks completed
- Integration test proves round-trip functionality
- Privacy sanitization verified in round-trip context
- Imported sessions work like native sessions (verified manually or via integration test)
- No errors or warnings introduced
- All 330+ tests still passing
</success_criteria>

<output>
After completion, create `.planning/phases/06-end-to-end-verification/06-01-SUMMARY.md`:

# Phase 6 Plan 1: End-to-End Verification Summary

**[Substantive one-liner - what was verified, not "tests passed"]**

## Accomplishments

- [Key verification outcomes]
- [Privacy guarantees confirmed]
- [Claude CLI integration status]

## Files Created/Modified

- `src/__tests__/e2e.test.ts` - End-to-end integration tests
- [Other files if modified]

## Decisions Made

[Key decisions during verification, or "None"]

## Issues Encountered

[Problems found and resolutions, or "None"]

## Next Step

Phase complete - project ready for use. Imported sessions are indistinguishable from native Claude Code sessions.
</output>

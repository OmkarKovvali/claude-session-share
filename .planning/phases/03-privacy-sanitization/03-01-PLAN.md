---
phase: 03-privacy-sanitization
plan: 01
type: execute
---

<objective>
Strip sensitive data from session messages before sharing: remove thinking blocks, sanitize absolute paths to relative, and redact secrets from tool results.

Purpose: Ensure shared sessions protect user privacy by removing Claude's internal thinking, user-specific file paths, and potentially sensitive data in tool outputs.
Output: Session sanitization utilities with comprehensive test coverage validating privacy guarantees.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-export/02-01-SUMMARY.md
@.planning/phases/02-session-export/02-02-SUMMARY.md
@src/session/types.ts

**Tech stack available:** TypeScript, Vitest, Node.js built-ins
**Established patterns:** Discriminated union types, async generators, per-function test files
**Constraining decisions:**
- Phase 2: Discriminated union types for message handling
- Phase 2: Node.js built-ins preferred over external dependencies

**Session message types to sanitize:**
- AssistantMessage: Contains `snapshot.thinking` (internal reasoning) and `snapshot.messages` (may contain tool results with secrets)
- UserMessage: Contains `cwd` (absolute path)
- FileHistorySnapshot: Contains `snapshot.files[].path` (absolute paths)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement thinking block removal and path sanitization utilities</name>
  <files>src/sanitization/sanitizer.ts, src/__tests__/sanitizer.test.ts</files>
  <action>
Create sanitization module with three core functions:

1. `sanitizeAssistantMessage(msg: AssistantMessage, basePath: string): AssistantMessage`
   - Strip thinking: Set `snapshot.thinking` to null
   - Sanitize paths in tool results: Replace absolute paths with relative paths based on basePath
   - Return new object (immutable transformation)

2. `sanitizeUserMessage(msg: UserMessage, basePath: string): UserMessage`
   - Sanitize `cwd`: Replace absolute path with relative path based on basePath
   - Return new object

3. `sanitizeFileHistorySnapshot(msg: FileHistorySnapshot, basePath: string): FileHistorySnapshot`
   - Sanitize all `snapshot.files[].path`: Replace absolute with relative paths
   - Return new object

Path sanitization logic:
- If path starts with basePath, replace with relative path (e.g., /Users/user/project/src/file.ts → src/file.ts)
- If path doesn't start with basePath, return as-is (external paths remain unchanged)
- Use Node.js `path.relative()` for proper cross-platform path handling

Why immutable: Preserves original session data for debugging, follows functional programming best practices.

Write comprehensive Vitest tests (20+ test cases):
- Thinking removal (with thinking, null thinking, empty string)
- Path sanitization (absolute → relative, already relative, external paths)
- Tool result sanitization (detect file paths in JSON tool results)
- Edge cases (empty messages, missing fields, malformed paths)
  </action>
  <verify>npm test runs all sanitizer tests, 100% passing. Build succeeds with no TypeScript errors.</verify>
  <done>sanitizer.ts exports three sanitization functions, all tests pass, strict TypeScript compliance.</done>
</task>

<task type="auto">
  <name>Task 2: Implement secret redaction in tool results</name>
  <files>src/sanitization/redactor.ts, src/__tests__/redactor.test.ts</files>
  <action>
Create redaction module for detecting and redacting secrets in tool result content:

1. `redactSecrets(content: string): string`
   - Detect common secret patterns:
     - API keys (keywords: api_key, apiKey, API_KEY, token, access_token, secret)
     - Environment variable values in .env format (KEY=value)
     - GitHub tokens (ghp_, ghs_, github_pat_)
     - AWS keys (AKIA, aws_secret_access_key)
     - Generic long strings that look like secrets (base64, hex strings >32 chars)
   - Replace detected secrets with `[REDACTED]`
   - Preserve structure (don't remove entire tool results, just redact sensitive values)
   - Use regex patterns for detection

2. Integrate into sanitizeAssistantMessage:
   - Apply redactSecrets to all `snapshot.messages[].content` strings
   - Particularly important for tool results in assistant responses

Pattern examples to detect:
- `"api_key": "sk-1234567890abcdef"` → `"api_key": "[REDACTED]"`
- `API_TOKEN=abc123def456` → `API_TOKEN=[REDACTED]`
- `ghp_1234567890abcdef1234567890abcdef` → `[REDACTED]`

Why pattern-based: Covers common secret formats without requiring external secret scanning libraries. Better false positive (redact too much) than false negative (leak secrets).

Write comprehensive tests (15+ cases):
- Each secret type detection
- Mixed content (text + secrets)
- No secrets present (unchanged)
- Edge cases (short values, partial matches)
  </action>
  <verify>npm test runs redactor tests, 100% passing. All secret patterns correctly detected and redacted.</verify>
  <done>redactor.ts exports redactSecrets function, integrated into sanitizeAssistantMessage, all tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: Create session sanitization pipeline with integration tests</name>
  <files>src/sanitization/pipeline.ts, src/__tests__/pipeline.test.ts</files>
  <action>
Create session sanitization pipeline that processes entire sessions:

1. `sanitizeSession(messages: SessionMessage[], basePath: string): SessionMessage[]`
   - Map over messages array
   - Use discriminated union type guards (if msg.type === 'assistant', etc.)
   - Apply appropriate sanitization function for each message type
   - Preserve message order and structure
   - Return new array (immutable)

2. `inferBasePath(messages: SessionMessage[]): string`
   - Utility to extract base path from session messages
   - Look for first UserMessage with cwd, extract parent directory
   - Fallback to empty string if no cwd found
   - Used when caller doesn't specify basePath

Write integration tests (10+ cases):
- Full session sanitization (mix of all message types)
- Verify thinking stripped from all assistant messages
- Verify paths sanitized in user messages
- Verify paths sanitized in file snapshots
- Verify secrets redacted in tool results
- Empty session handling
- Session with only one message type
- inferBasePath accuracy

Create fixture data:
- Small realistic session snippets (3-5 messages) with:
  - Assistant message with thinking block + tool result containing API key
  - User message with absolute cwd
  - File history snapshot with absolute paths
  </action>
  <verify>npm test runs pipeline tests, 100% passing. Full session sanitization works end-to-end.</verify>
  <done>pipeline.ts exports sanitizeSession and inferBasePath, all integration tests pass, ready for Phase 4 integration.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm test` passes all tests (40+ tests across sanitizer, redactor, pipeline)
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] All three message types sanitized correctly
- [ ] Thinking blocks stripped from assistant messages
- [ ] Secrets redacted from tool results
- [ ] Absolute paths converted to relative paths
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No new dependencies added (Node.js built-ins only)
- Sanitization is immutable (returns new objects)
- Comprehensive test coverage (40+ tests)
- Ready for Phase 4 (Gist integration will use sanitizeSession before upload)
</success_criteria>

<output>
After completion, create `.planning/phases/03-privacy-sanitization/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Privacy Sanitization Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for Phase 4 (Gist Storage)
</output>

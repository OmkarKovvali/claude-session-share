---
phase: 04-gist-storage
plan: 01
type: execute
---

<objective>
Set up authenticated GitHub Gist client using Octokit with rate limiting, retry logic, and file truncation handling.

Purpose: Establish the infrastructure for uploading sanitized sessions to GitHub Gist as secret (unlisted) gists.
Output: Working Gist client module that can create secret gists with automatic rate limit and retry handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gist-storage/04-RESEARCH.md
@.planning/phases/03-privacy-sanitization/03-01-SUMMARY.md
@src/session/types.ts
@package.json

**Tech stack available:**
- TypeScript with strict mode enabled
- Vitest for testing
- Node.js built-in modules (fs, path, readline)

**Established patterns:**
- Discriminated union types for message handling
- Async generator pattern for streaming
- Node.js built-ins only (no external dependencies so far)
- Per-file test suites with realistic fixtures

**Constraining decisions:**
- Phase 1: Strict TypeScript from start - catch errors early
- Phase 2-01: Node.js built-ins preferred - avoid external deps when possible
- Phase 3-01: Immutable transformations - preserve originals for debugging

**From research (04-RESEARCH.md):**
- Use Octokit v5 (official GitHub SDK) - don't hand-roll HTTP client
- Auth via GITHUB_TOKEN environment variable
- Create secret gists with `public: false`
- Handle file truncation for files > 1MB (check `truncated` field, fetch from `raw_url`)
- Use Octokit throttling plugin for automatic rate limit handling
- Error handling: 401 (invalid token), 403 (permissions/rate limit), 422 (invalid data)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Octokit and create authenticated Gist client wrapper</name>
  <files>package.json, src/gist/client.ts, src/__tests__/gist-client.test.ts</files>
  <action>
    Install Octokit: `npm install octokit`. Create src/gist/client.ts with a GistClient class that initializes Octokit with GITHUB_TOKEN from environment. Configure throttling plugin with custom callbacks for rate limit awareness (retry up to 3 times on primary rate limits, always retry secondary rate limits). Add error handling for missing/invalid tokens (throw descriptive errors for 401/403). Create basic tests that verify client initialization (mock process.env.GITHUB_TOKEN) and error handling for missing token.

    Use Octokit v5 initialization pattern from research:
    ```typescript
    new Octokit({
      auth: process.env.GITHUB_TOKEN,
      throttle: {
        onRateLimit: (retryAfter, options, octokit, retryCount) => retryCount < 3,
        onSecondaryRateLimit: (retryAfter, options, octokit) => true,
      }
    })
    ```

    DO NOT use node-fetch or custom HTTP clients - Octokit handles all HTTP logic.
    DO NOT implement custom retry logic - use Octokit's built-in plugin-retry.
  </action>
  <verify>npm test runs successfully, TypeScript compiles without errors</verify>
  <done>Octokit installed in package.json, GistClient class exists with proper error handling, tests pass for initialization and missing token scenarios</done>
</task>

<task type="auto">
  <name>Task 2: Implement Gist creation with truncation handling</name>
  <files>src/gist/client.ts, src/gist/types.ts, src/__tests__/gist-client.test.ts</files>
  <action>
    Add createGist() method to GistClient that accepts description, files object (filename â†’ content), and returns GistResponse with { url, id, files }. Use octokit.rest.gists.create() with `public: false` for secret gists. Create src/gist/types.ts with GistResponse and GistFile interfaces (use Octokit's types where possible). Add error handling for 401 (invalid token), 403 (missing permissions or rate limit), 422 (invalid data). Add tests that verify secret gist creation (mock octokit.rest.gists.create), error handling for different status codes, and response structure.

    Follow pattern from research for secret gist creation:
    ```typescript
    await octokit.rest.gists.create({
      description: description,
      public: false, // Secret gist
      files: { /* filename: { content: string } */ }
    })
    ```

    DO NOT implement file truncation handling yet (reading gists comes in Phase 5 - this task is upload only).
    DO NOT add custom validation beyond what Octokit provides - trust GitHub API validation.
    Include descriptive error messages that mention GITHUB_TOKEN setup if 401/403 occurs.
  </action>
  <verify>npm test passes with new gist creation tests, npm run build succeeds without errors</verify>
  <done>GistClient.createGist() method exists, returns properly typed GistResponse, handles all documented error cases, tests verify secret gist creation and error scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes all tests (existing + new gist-client tests)
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] GistClient properly handles missing GITHUB_TOKEN (throws descriptive error)
- [ ] GistClient properly handles Octokit rate limiting (configured throttling plugin)
- [ ] createGist() returns expected response structure
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors or warnings
- Octokit installed and properly configured
- GistClient with createGist() method ready for integration
- Comprehensive test coverage for auth and gist creation
</success_criteria>

<output>
After completion, create `.planning/phases/04-gist-storage/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Gist Client Infrastructure Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 04-02-PLAN.md (Share tool implementation)
</output>

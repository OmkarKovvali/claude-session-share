---
phase: 04-gist-storage
plan: 02
type: execute
---

<objective>
Integrate sanitization pipeline with Gist upload and expose `/share` MCP tool for sharing Claude Code sessions.

Purpose: Complete the session sharing workflow by connecting sanitization → gist upload → shareable URL.
Output: Working `/share` MCP tool that sanitizes current session and returns GitHub Gist URL.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gist-storage/04-RESEARCH.md
@.planning/phases/04-gist-storage/04-01-SUMMARY.md
@.planning/phases/03-privacy-sanitization/03-01-SUMMARY.md
@.planning/phases/02-session-export/02-02-SUMMARY.md
@src/session/types.ts
@src/session/reader.ts
@src/session/finder.ts
@src/session/metadata.ts
@src/sanitization/pipeline.ts
@src/gist/client.ts
@src/index.ts

**Tech stack available:**
- TypeScript with strict mode
- Vitest for testing
- Octokit v5 for GitHub Gist API
- Node.js built-in modules

**Established patterns:**
- Discriminated unions for message handling
- Immutable transformations in sanitization
- Async generators for streaming file reads
- MCP SDK Server and tool registration

**Constraining decisions:**
- Phase 1: MCP SDK with stdio transport
- Phase 2-02: Session discovery from ~/.claude/projects/
- Phase 3-01: sanitizeSession() for full privacy pipeline
- Phase 4-01: GistClient with authenticated Octokit

**Integration points:**
- src/session/finder.ts: findSessions() - lists available sessions
- src/session/reader.ts: readSessionMessages() - reads JSONL
- src/session/metadata.ts: extractSessionMetadata() - gets title/timestamp
- src/sanitization/pipeline.ts: sanitizeSession() - privacy sanitization
- src/gist/client.ts: GistClient.createGist() - uploads to GitHub

**Issues being addressed:** None from ISSUES.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session-to-gist upload service</name>
  <files>src/services/session-uploader.ts, src/__tests__/session-uploader.test.ts</files>
  <action>
    Create src/services/ directory and session-uploader.ts with uploadSession() function that orchestrates: (1) read session messages with readSessionMessages(), (2) sanitize with sanitizeSession(), (3) convert sanitized messages to JSONL string, (4) extract metadata with extractSessionMetadata(), (5) upload via GistClient.createGist() with two files: "session.jsonl" (sanitized messages) and "metadata.json" (session metadata). Return gist URL. Add comprehensive tests that mock all dependencies and verify: correct call sequence, JSONL formatting (one message per line), metadata JSON structure, error propagation from each step.

    Session title for gist description: Use metadata.title if available, fallback to "Claude Code Session - {timestamp}".

    JSONL formatting: Use messages.map(m => JSON.stringify(m)).join('\n') for proper JSONL format.

    DO NOT load entire session into memory as array - use async generator from readSessionMessages(), collect into array, sanitize array, then convert to JSONL string. This is acceptable because sanitization operates on full session array.

    Error handling: Let errors propagate from dependencies (readSessionMessages, sanitizeSession, createGist) with descriptive context about which step failed.
  </action>
  <verify>npm test passes with session-uploader tests verifying orchestration, JSONL format, and error handling</verify>
  <done>uploadSession() function exists, correctly chains session reading → sanitization → gist upload, returns gist URL, comprehensive tests verify integration and error cases</done>
</task>

<task type="auto">
  <name>Task 2: Add /share MCP tool with session selection</name>
  <files>src/index.ts, src/__tests__/mcp-integration.test.ts</files>
  <action>
    Register "share_session" tool in src/index.ts using server.setRequestHandler("tools/list") and server.setRequestHandler("tools/call"). Tool schema: takes optional sessionPath argument (string, defaults to most recent session). Implementation: (1) if no sessionPath provided, call findSessions() and use most recent, (2) validate session path exists, (3) call uploadSession() with path, (4) return formatted response with gist URL and success message. Add tool input schema following MCP SDK patterns (see @modelcontextprotocol/sdk docs). Add integration tests that verify tool registration (tools/list returns share_session), tool execution with explicit path, tool execution without path (uses most recent), error handling for invalid paths and missing GITHUB_TOKEN.

    Tool name: "share_session" (underscore, not dash - MCP convention)
    Tool description: "Share a Claude Code session via GitHub Gist. Creates a sanitized, shareable link to the conversation."

    Input schema:
    ```json
    {
      "type": "object",
      "properties": {
        "sessionPath": {
          "type": "string",
          "description": "Optional path to session file. If not provided, shares the most recent session."
        }
      }
    }
    ```

    Response format: Return MCP tool response with isError: false on success, isError: true on failure. Include gist URL in success message.

    DO NOT implement session listing tool yet (Phase 5 will add import-related tools).
    DO NOT add authentication checking in tool handler - let GistClient handle auth errors and propagate them.
  </action>
  <verify>npm test passes with MCP integration tests, npm run build succeeds, tool appears in tools/list response</verify>
  <done>share_session tool registered in MCP server, accepts optional sessionPath, uses most recent if omitted, returns gist URL on success, comprehensive tests verify tool registration and execution</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes all tests (146 existing + new uploader + MCP tests)
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] share_session tool properly registered in MCP server
- [ ] Tool works with explicit session path
- [ ] Tool works without path (uses most recent session)
- [ ] Error messages are descriptive (missing token, invalid path, etc.)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors or warnings
- Complete session sharing workflow working end-to-end
- /share tool ready for manual testing with Claude Code
- Phase 4 complete - ready for Phase 5 (Session Import)
</success_criteria>

<output>
After completion, create `.planning/phases/04-gist-storage/04-02-SUMMARY.md`:

# Phase 4 Plan 2: Share Tool Implementation Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 4 complete. Ready for Phase 5: Session Import.
</output>

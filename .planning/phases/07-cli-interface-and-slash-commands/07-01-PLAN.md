---
phase: 07-cli-interface-and-slash-commands
plan: 01
type: execute
---

<objective>
Add standalone CLI interface enabling direct command-line usage without MCP

Purpose: Allow users to run `npx claude-session-share share` and `npx claude-session-share import <url>` directly from terminal, enabling usage outside Claude Code context and simpler testing/automation.
Output: Working CLI with share/import commands, argument parsing, and proper error handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/session-uploader.ts
@src/services/session-importer.ts
@src/index.ts
@package.json

**Tech stack available:**
- TypeScript with strict mode, ES2022, Node16 modules
- Vitest for testing
- Octokit for GitHub API
- MCP SDK for stdio transport

**Established patterns:**
- Async generator pattern for streaming
- Per-line error recovery in JSONL parsing
- Immutable transformations for sanitization
- Service layer pattern (orchestration separate from MCP handlers)

**Constraining decisions:**
- Node.js built-ins preferred (no external CLI parsing libs needed)
- ES2022 + Node16 modules for proper ESM resolution
- Functional programming style with immutability

**Current state:**
- MCP server in src/index.ts handles stdio transport and tool calls
- uploadSession service in src/services/session-uploader.ts orchestrates share workflow
- importSession service in src/services/session-importer.ts orchestrates import workflow
- package.json has bin field pointing to dist/index.js (currently MCP server entry)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI entry point with command routing</name>
  <files>src/cli.ts</files>
  <action>
Create CLI entry point that:
- Checks process.argv for CLI mode (has arguments) vs MCP mode (no arguments/stdio)
- Parses commands: "share" with optional --session-path, "import" with required gist-url and optional --project-path
- Routes to existing uploadSession/importSession services
- Handles errors with user-friendly messages
- Returns exit codes (0 success, 1 error)

Structure:
```typescript
#!/usr/bin/env node
import { uploadSession } from './services/session-uploader.js';
import { importSession } from './services/session-importer.js';

async function main() {
  const args = process.argv.slice(2);

  if (args.length === 0) {
    console.log('Usage: ...');
    process.exit(1);
  }

  const command = args[0];

  if (command === 'share') {
    // Parse --session-path flag, default to most recent
    // Call uploadSession
    // Print gist URL
  } else if (command === 'import') {
    // Parse gist URL (required)
    // Parse --project-path flag, default to cwd
    // Call importSession
    // Print success message
  } else {
    console.error('Unknown command');
    process.exit(1);
  }
}

main().catch(err => {
  console.error('Error:', err.message);
  process.exit(1);
});
```

DO NOT use external CLI parsing libraries (commander, yargs, etc.) - Node.js argv parsing is sufficient for two simple commands. Keep it lightweight.
  </action>
  <verify>
Manual test commands:
- `node dist/cli.js share` should upload most recent session
- `node dist/cli.js share --session-path /path/to/session.jsonl` should upload specific session
- `node dist/cli.js import <gist-url> --project-path /tmp/test` should import to test directory
- `node dist/cli.js` with no args should show usage
- `node dist/cli.js unknown` should error with "Unknown command"
  </verify>
  <done>
CLI entry point exists, parses share/import commands, routes to services, handles errors, returns appropriate exit codes
  </done>
</task>

<task type="auto">
  <name>Task 2: Update package.json bin to point to CLI, add MCP mode detection to index.ts</name>
  <files>package.json, src/index.ts, src/cli.ts</files>
  <action>
1. Update package.json bin field to point to CLI entry:
   - Change `"bin": {"claude-session-share": "dist/index.js"}` to `"bin": {"claude-session-share": "dist/cli.js"}`

2. Add MCP mode detection logic to src/cli.ts that:
   - If CLI arguments exist: run CLI mode
   - If no CLI arguments (stdin is TTY and no args): run MCP server mode by importing and executing src/index.ts main()
   - This allows single entry point for both CLI and MCP usage

Structure for src/cli.ts:
```typescript
#!/usr/bin/env node
import { stdin } from 'process';

async function main() {
  const args = process.argv.slice(2);

  // If no args and stdin is not a TTY, assume MCP stdio mode
  if (args.length === 0 && !stdin.isTTY) {
    // Import and run MCP server
    const { default: runMCPServer } = await import('./index.js');
    return runMCPServer();
  }

  // Otherwise, run CLI mode
  // ... CLI command parsing logic ...
}
```

3. Refactor src/index.ts to export main function:
   - Change bottom of file from `main().catch(...)` to `export default main;` and add separate starter if not imported
   - This allows cli.ts to import and call the MCP server when needed

DO NOT duplicate MCP server logic - keep src/index.ts as the MCP implementation, just make it importable.
  </action>
  <verify>
- `npm run build` succeeds
- `node dist/cli.js share` runs CLI mode
- `echo "" | node dist/cli.js` with stdin pipe runs MCP mode
- `npx claude-session-share share` works after build
  </verify>
  <done>
package.json points to cli.js, CLI detects MCP vs CLI mode correctly, MCP server importable from index.ts, both modes work independently
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CLI tests and update README</name>
  <files>src/__tests__/cli.test.ts, README.md</files>
  <action>
1. Create src/__tests__/cli.test.ts with tests for:
   - Share command with default session (most recent)
   - Share command with --session-path flag
   - Import command with gist URL and default project path
   - Import command with --project-path flag
   - Unknown command error handling
   - Missing required arguments error handling
   - Help text display

Mock uploadSession and importSession services using vi.mock.

2. Update README.md to document CLI usage:
   - Add "CLI Usage" section after "Usage" section
   - Show `npx claude-session-share share` examples
   - Show `npx claude-session-share import <url>` examples
   - Document flags: --session-path, --project-path
   - Keep existing MCP usage documentation (both usage modes are valid)

Structure for CLI tests:
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { uploadSession } from '../services/session-uploader.js';
import { importSession } from '../services/session-importer.js';

vi.mock('../services/session-uploader.js');
vi.mock('../services/session-importer.js');

describe('CLI', () => {
  beforeEach(() => {
    vi.resetAllMocks();
  });

  it('should share most recent session when no path provided', async () => {
    // Mock uploadSession
    // Simulate running: node cli.js share
    // Verify uploadSession called with null/undefined path
  });

  // ... more tests ...
});
```

DO NOT remove or significantly change existing MCP documentation - CLI is an additional usage mode, not a replacement.
  </action>
  <verify>
- `npm test` passes all tests including new CLI tests
- README.md has new "CLI Usage" section with examples
- `npm run build` succeeds with no errors
  </verify>
  <done>
CLI test suite passing, README documents both CLI and MCP usage modes, all 337+ tests passing
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests (337+ tests)
- [ ] Manual CLI test: `node dist/cli.js share` works
- [ ] Manual CLI test: `node dist/cli.js import <gist-url> --project-path /tmp/test` works
- [ ] README documents CLI usage with examples
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- CLI entry point works standalone (share and import commands)
- MCP server mode still works via stdio
- Tests cover CLI argument parsing and error handling
- README documents both usage modes
- No TypeScript errors or test failures
  </success_criteria>

<output>
After completion, create `.planning/phases/07-cli-interface-and-slash-commands/07-01-SUMMARY.md`:

# Phase 7 Plan 1: CLI Interface Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/cli.ts` - CLI entry point with command routing
- `src/index.ts` - Refactored to be importable for MCP mode
- `package.json` - Updated bin to point to cli.js
- `src/__tests__/cli.test.ts` - CLI test suite
- `README.md` - Added CLI usage documentation

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 07-02-PLAN.md (MCP prompts for slash commands)
</output>
